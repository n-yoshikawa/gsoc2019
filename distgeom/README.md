# distgeom
## 2019/06/25
Use fragment-based builder for distance bound and initial distance matrix (time: 431.924s / 1000 mols)

```
RMSD:		 1.8629349777666824
Bond error:	 0.061200313503077045
Angle error:	 5.605110793473117
Torsion error:	 55.673413412074304
TFD:		 0.47634733469507534
Stereo correct:	 95.5
```

Bond, angle error improved. The problem that distance matrix generated by fragment did not satisfy distance bounds seems to be the main reason of bigger error.

I'm considering two methods to treat fragment during refinement process.
1. Use the same gradient for all atoms of a fragment by taking average. All atoms in a fragment will move for the same degree.
2. Optimize distance matrix decided instead of optimizing coordinates of atoms. The distance decided by fragment can be fixed and it would fix the shape of a fragment as well as reduce computation time.
## 2019/06/24
Use fragment-based builder for initialization (time: 252.568s / 1000 mols)
```
RMSD:		 1.8649386968517287
Bond error:	 0.11796677033394212
Angle error:	 10.93606491851455
Torsion error:	 64.62098300560682
TFD:		 0.5932202012460935
Stereo correct:	 99.5
```

It did not contribute to better accuracy.

I noticed that distance constraints from fragments did not satisfy calculated bounds. We may need to fix. e.g. 
```
O=C1CCCN1
(24, 24): 0 < 0 < 0
(24, 23): 1.41385 < 1.22481 < 1.41385
(24, 22): 2.31137 < 2.4246 < 2.37137
(24, 27): 2.98957 < 3.51907 < 3.57432
(24, 26): 2.94157 < 3.52786 < 3.48861
(24, 25): 2.23544 < 2.31227 < 2.29544
(23, 24): 1.41385 < 1.22481 < 1.41385
(23, 23): 0 < 0 < 0
(23, 22): 1.72347 < 1.49538 < 1.72347
(23, 27): 2.32784 < 2.36185 < 2.35784
(23, 26): 2.25235 < 2.34612 < 2.28235
(23, 25): 1.44385 < 1.36412 < 1.44385
(22, 24): 2.31137 < 2.4246 < 2.37137
(22, 23): 1.72347 < 1.49538 < 1.72347
(22, 22): 0 < 0 < 0
(22, 27): 1.72347 < 1.53113 < 1.72347
(22, 26): 2.35767 < 2.37601 < 2.38767
(22, 25): 2.29121 < 2.31103 < 2.32121
(27, 24): 2.98957 < 3.51907 < 3.57432
(27, 23): 2.32784 < 2.36185 < 2.35784
(27, 22): 1.72347 < 1.53113 < 1.72347
(27, 27): 0 < 0 < 0
(27, 26): 1.60863 < 1.51012 < 1.60863
(27, 25): 2.29089 < 2.33461 < 2.32089
(26, 24): 2.94157 < 3.52786 < 3.48861
(26, 23): 2.25235 < 2.34612 < 2.28235
(26, 22): 2.35767 < 2.37601 < 2.38767
(26, 27): 1.60863 < 1.51012 < 1.60863
(26, 26): 0 < 0 < 0
(26, 25): 1.4195 < 1.46455 < 1.4495
(25, 24): 2.23544 < 2.31227 < 2.29544
(25, 23): 1.44385 < 1.36412 < 1.44385
(25, 22): 2.29121 < 2.31103 < 2.32121
(25, 27): 2.29089 < 2.33461 < 2.32089
(25, 26): 1.4195 < 1.46455 < 1.4495
(25, 25): 0 < 0 < 0
```
## 2019/06/23
Use fragment information for distance constraints.
```
RMSD:		 1.9052187699834369
Bond error:	 0.1066561281235832
Angle error:	 9.928999359063296
Torsion error:	 62.943971896249806
TFD:		 0.46985033998316433
Stereo correct:	 99.2
```

It did not contribute to better accuracy. It may be better to use fragment information to decide initial geometry.

## 2019/06/22
Full dataset evaluation of distance geometry. (time: 743.839s)
```
RMSD:		 1.861095663111644
Bond error:	 0.11746152138644293
Angle error:	 10.622304347896602
Torsion error:	 63.7480769624682
TFD:		 0.5473824428150154
Stereo correct:	 99.20679886685552
```

Combination of fragment-based method and using DG as back-up. (time: 10.416s)
```
RMSD:		 1.8133531399495717
Bond error:	 0.050662140475224396
Angle error:	 2.594241920508891
Torsion error:	 43.31872350822983
TFD:		 0.2756801308082744
Stereo correct:	 96.1
```

Stereo correct should be higher.
Something is wrong with stereochemistry correctness check function.

## 2019/06/17
I found treating hydrogens explicitly greatly improves stereo accuracy.
```
RMSD:		 1.761661062184551
Bond error:	 0.047160183218586865
Angle error:	 2.365066621227538
Torsion error:	 44.02308213424224
TFD:		 0.3398617453755661
Stereo correct:	 99.60552268244575
```

Segmentation fault occurs because of implicit hydrogens. I need to fix.
## 2019/06/14
Implemented 4th dimentional penalty minimization.
It contributed smaller error.
```
RMSD:		 1.784862089493353
Bond error:	 0.046846102579575444
Angle error:	 2.32028908052611
Torsion error:	 44.62221425930382
TFD:		 0.3329742280797641
Stereo correct:	 88.0
```
## 2019/06/13
Debug and evaluate using initial 1000 molecules in the Platinum dataset.
Run distance geometry (without fragment knowledge) and run MMFF (med).
```
$ time obabel platinum1000.smi -O platinum1000-obabel-dg2.sdf --gen3d dg
real	3m22.329s
user	3m6.751s
sys	0m15.528s
$ python stat-result.py eval-ob-new-dg.csv 
RMSD:		 1.953698364798107
Bond error:	 0.1600978932226922
Angle error:	 12.953547681617396
Torsion error:	 61.45940387853891
TFD:		 0.6780934483991995
Stereo correct:	 87.1
```

The result was not good in terms of all metrics compared to the fragment-based builder.
## 2019/06/12
Distance geometry including chiral error started to work.
```
$ obabel -ican -:"N[C@@H](C)C(=O)O" -O test.sdf --gen3d dg
(long log)
$ obabel test.sdf -oinchi
InChI=1S/C3H7NO2/c1-2(4)3(5)6/h2H,4H2,1H3,(H,5,6)/t2-/m0/s1
1 molecule converted
$ obabel -ican -:"N[C@@H](C)C(=O)O" -oinchi               
InChI=1S/C3H7NO2/c1-2(4)3(5)6/h2H,4H2,1H3,(H,5,6)/t2-/m0/s1
1 molecule converted
```
```
$ obabel -ican -:"N[C@H](C)C(=O)O" -O test.sdf --gen3d dg
(long log)
$ obabel test.sdf -oinchi
InChI=1S/C3H7NO2/c1-2(4)3(5)6/h2H,4H2,1H3,(H,5,6)/t2-/m1/s1
1 molecule converted
$ obabel -ican -:"N[C@H](C)C(=O)O" -oinchi
InChI=1S/C3H7NO2/c1-2(4)3(5)6/h2H,4H2,1H3,(H,5,6)/t2-/m1/s1
1 molecule converted
```
```
$ obabel -ican -:"O[C@H]1CCCC[C@H]1O" -O test.sdf --gen3d dg
(long log)
$ obabel test.sdf -oinchi
InChI=1S/C6H12O2/c7-5-3-1-2-4-6(5)8/h5-8H,1-4H2/t5-,6+
1 molecule converted
$ obabel -ican -:"O[C@H]1CCCC[C@H]1O" -oinchi
InChI=1S/C6H12O2/c7-5-3-1-2-4-6(5)8/h5-8H,1-4H2/t5-,6+
```
```
$ obabel -ican -:"C1C[C@H]2CCCC[C@H]2CC1" -O test.sdf --gen3d dg
(long log)
$ obabel test.sdf -oinchi
==============================
*** Open Babel Warning  in InChI code
  #1 :Omitted undefined stereo
InChI=1S/C10H18/c1-2-6-10-8-4-3-7-9(10)5-1/h9-10H,1-8H2
1 molecule converted
$ obabel -ican -:"C1C[C@H]2CCCC[C@H]2CC1" -oinchi
InChI=1S/C10H18/c1-2-6-10-8-4-3-7-9(10)5-1/h9-10H,1-8H2/t9-,10+
1 molecule converted
```

## 2019/06/08
BFGS (only distance contraint) worked.
```
$ obabel -:"C/C=C/C" -osdf --gen3d dg 2>&1
(omission)
stereo: ok, bounds: ok

 OpenBabel06081916413D

 12 11  0  0  0  0  0  0  0  0999 V2000
    1.7891   -0.0944    0.4885 C   0  0  0  0  0  0  0  0  0  0  0  0
    0.3262   -0.3716    0.4692 C   0  0  0  0  0  0  0  0  0  0  0  0
   -0.3103   -0.1018   -0.5002 C   0  0  0  0  0  0  0  0  0  0  0  0
   -1.7865    0.0712   -0.4122 C   0  0  0  0  0  0  0  0  0  0  0  0
    1.7576    1.0582    0.4892 H   0  0  0  0  0  0  0  0  0  0  0  0
    2.0297   -0.1252   -0.6169 H   0  0  0  0  0  0  0  0  0  0  0  0
    1.8551   -0.3016    0.3107 H   0  0  0  0  0  0  0  0  0  0  0  0
    0.0004   -1.2135    0.9038 H   0  0  0  0  0  0  0  0  0  0  0  0
    0.2006    0.5773   -0.9308 H   0  0  0  0  0  0  0  0  0  0  0  0
   -1.9147   -0.2945   -0.4561 H   0  0  0  0  0  0  0  0  0  0  0  0
   -2.0788   -0.3331    0.4610 H   0  0  0  0  0  0  0  0  0  0  0  0
   -1.8684    1.1290   -0.2062 H   0  0  0  0  0  0  0  0  0  0  0  0
  1  2  1  0  0  0  0
  1  5  1  0  0  0  0
  1  6  1  0  0  0  0
  1  7  1  0  0  0  0
  2  3  2  0  0  0  0
  2  8  1  0  0  0  0
  3  4  1  0  0  0  0
  3  9  1  0  0  0  0
  4 10  1  0  0  0  0
  4 11  1  0  0  0  0
  4 12  1  0  0  0  0
M  END
$$$$
```

## 2019/06/07
Initial coordinate generation seems to be working.
```
$ obabel -:"CCC" -osdf --gen3d dg 2>&1
distMat:
      0 1.52283 2.44451 1.06229 1.06798 1.07708  2.1288 2.10233 2.82931 3.01097 3.30119
1.52283       0 1.52017 2.10003 2.11409  2.0963 1.08191 1.06247 2.09705 2.09866 2.11275
2.44451 1.52017       0 3.38414 3.16966 3.44374 2.13054 2.09971 1.06399 1.08344 1.08349
1.06229 2.10003 3.38414       0 1.75685 1.71467 2.73316 2.80829 3.32909 2.43157 2.76391
1.06798 2.11409 3.16966 1.75685       0 1.71404 2.33809 2.18356  2.7802 2.75476 2.37923
1.07708  2.0963 3.44374 1.71467 1.71404       0 2.88605  2.3911 2.83423 2.37511 3.02778
 2.1288 1.08191 2.13054 2.73316 2.33809 2.88605       0 1.74455 2.99853 2.64792 2.31662
2.10233 1.06247 2.09971 2.80829 2.18356  2.3911 1.74455       0 2.65916 2.47535 2.64034
2.82931 2.09705 1.06399 3.32909  2.7802 2.83423 2.99853 2.65916       0 1.74319 1.70984
3.01097 2.09866 1.08344 2.43157 2.75476 2.37511 2.64792 2.47535 1.74319       0 1.72413
3.30119 2.11275 1.08349 2.76391 2.37923 3.02778 2.31662 2.64034 1.70984 1.72413       0
generated distance matrix
       0  1.55935  3.07861  1.69731  1.45074  1.05338  2.19917  1.56198   2.9306  2.83274  3.18591
 1.55935        0   1.7115  2.21981  2.03352  2.08473  1.08439 0.525141  2.21146  1.97763  2.20771
 3.07861   1.7115        0  3.42766  3.16741   3.2515  2.18677  1.91206   1.4328  1.60148  1.69223
 1.69731  2.21981  3.42766        0  1.70415  1.30998  2.60476  2.57509  3.33209  2.48197  2.90939
 1.45074  2.03352  3.16741  1.70415        0  1.59063  2.30819   2.1448  2.80061  2.88141  2.54445
 1.05338  2.08473   3.2515  1.30998  1.59063        0  2.86321  2.28247  2.80222  2.51648  3.12989
 2.19917  1.08439  2.18677  2.60476  2.30819  2.86321        0  1.15822  2.96384  2.65864  2.34612
 1.56198 0.525141  1.91206  2.57509   2.1448  2.28247  1.15822        0  2.37616  2.43519  2.55215
  2.9306  2.21146   1.4328  3.33209  2.80061  2.80222  2.96384  2.37616        0   1.7171   1.8226
 2.83274  1.97763  1.60148  2.48197  2.88141  2.51648  2.65864  2.43519   1.7171        0  1.67475
 3.18591  2.20771  1.69223  2.90939  2.54445  3.12989  2.34612  2.55215   1.8226  1.67475        0
```
## 2019/06/05
Finished implementing BFGS, but not working.

1. initial coordinate generation is wrong. Calculated coordinates do not yield correct distance matrix. e.g.
```
$ obabel -:"C" -osdf --gen3d dg
distMat:
      0 1.06214   1.077 1.05546 1.07546
1.06214       0 1.76926 1.75836 1.72459
  1.077 1.76926       0 1.73532 1.73928
1.05546 1.75836 1.73532       0 1.75684
1.07546 1.72459 1.73928 1.75684       0
(omission)
coord:
 -0.00213807
    0.769541
   -0.600926
-5.06441e-09
  -0.0176648
   -0.397392
    0.654739
-6.69999e-09
  -0.0050872
   -0.622523
   -0.560298
 3.26094e-09
   -0.564044
   -0.551822
   -0.541658
-4.66617e-09
    -1.12794
    0.283521
    0.264277
 2.43322e-09
generated distance matrix
       0  1.71425  1.39266   1.4371  1.50074
 1.71425        0  1.23578  1.32429  1.35971
 1.39266  1.23578        0 0.563718  1.66181
  1.4371  1.32429 0.563718        0  1.29047
 1.50074  1.35971  1.66181  1.29047        0
 ```

2. BFGS did not converge. I believe this is partially because of wrong initial coordinates, so I should solve 1 first. 

## 2019/05/29
Try approach A (use distance geometry for out-of-list fragments).

Distance geometry for `O=C1OC(C(=O)N1)C` did not stop, so generation did not stop.

## 2019/05/27
Conducted initial evaluation (9cf8b4).

Evaluating all molecules in platinum dataset took too long time, so evaluated only 1000.

```
$ time obabel platinum1000.smi -O platinum1000-ob-dg.sdf --gen3d dg
real	4m14.312s
user	4m13.651s
sys	0m0.601s
$ python evaluation.py platinum1000-ob-dg.sdf
same: 939/1000, rmsd: 2.1238465281154926
```

# Worklog
## 2019/07/24
Update fragment embedding ETKDG to add hydrogen before generating fragments and use loose bounds for fragment and non-fragment atoms.
```
Execution time: 546.8s
RMSD:		 1.7573520337390227
Bond error:	 0.11225606188088266
Angle error:	 4.473206076508021
Torsion error:	 45.23117476219159
TFD:		 0.22898344573283141
Stereo correct:	 98.48284960422163
```
## 2019/07/19
Found `DG.DoTriangleSmoothing(bm)` generates incorrect bounds.
The result fragment-constrained ETKDG after removing smoothing:
```
Execution time: 878.2s
RMSD:		 1.6866975065548626
Bond error:	 0.06027678700780884
Angle error:	 2.957182986106555
Torsion error:	 44.62808035409985
TFD:		 0.22151221403122506
Stereo correct:	 99.47229551451187
```
The accuracy is almost the same as original ETKDG, but the execution time is 3 times longer.
The longer execution time is probably caused by bad initial geometry due to ommission of triangle smoothing as well as fragment search.

# 2019/07/15
Changed to use ETKDG.
```
Execution time: 424.5s
RMSD:		 1.5945359521429254
Bond error:	 1.093951581870917
Angle error:	 31.290733331547624
Torsion error:	 65.70060774096676
TFD:		 0.22166750187316292
Stereo correct:	 68.13984168865436
```

In ETKDG, the following error occured. This did not occur in yesterday's version.
```
****
Pre-condition Violation
bad bounds
Violation occurred on line 26 in file /src/rdkit/Code/ForceField/UFF/DistanceConstraint.cpp
Failed Expression: maxLen >= minLen
****
```
Add hydrogens before running ETKDG.
```
Execution time: 533.7s
RMSD:		 1.6964020235897392
Bond error:	 0.07096308934780506
Angle error:	 3.9821001757855554
Torsion error:	 44.51026908157375
TFD:		 0.2223829307028473
Stereo correct:	 98.81266490765171
```
## 2019/07/13
Fragments are generated by `fragment-rdkit.py` and coordinates are predicted by `useFragment.py`.
The result was not good.

```
Execution time: 409.9s
RMSD:		 2.114852261493066
Bond error:	 0.048731483612639015
Angle error:	 5.17397814236974
Torsion error:	 52.66395914923287
TFD:		 0.3590947415891406
Stereo correct:	 98.26297273526825
```

cf. ETKDG
```
Execution time: 274.6s
RMSD:		 1.5884792268202588
Bond error:	 0.060366011566018334
Angle error:	 2.8710107163776186
Torsion error:	 43.87063444926612
TFD:		 0.2145041011963098
Stereo correct:	 99.45030782761654
```
## 2019/07/12
Try setting boundary from fragments, but it did not work well.

### Experimental structure
![Experiment](https://user-images.githubusercontent.com/29328746/61119850-a766ce80-a4d6-11e9-8e2e-1391b6d0c7d6.png)
### Predicted structure
![Predicted](https://user-images.githubusercontent.com/29328746/61119903-c49b9d00-a4d6-11e9-9ca8-2ef9b0ba257d.png)

The most suspicious reason is wrong treatment of fragment index.
Canonical index of fragment when generating fragment

```
$ python3 fragment-rdkit.py 003_2JFZ_A.sdf 
2019.09.1dev1
CC(C)Cn1c(=O)n(C)c(=O)c2c(-c3ccncc3)n(Cc3cccc4ccccc34)nc21
[24, 4, 32, 17, 29, 0, 1, 28, 19, 30, 16, 21, 26, 15, 7, 5, 13, 25, 14, 6, 12, 22, 20, 10, 8, 18, 9, 11, 27, 23, 3, 31, 2]
Cn1c(=O)[nH]c2n[nH]cc2c1=O
match: (32, 31, 0, 1, 2, 7, 8, 9, 21, 28, 29, 30)
canonical: [2, 31, 24, 4, 32, 28, 19, 30, 22, 27, 23, 3]
c1ccc2ccccc2c1
match: (14, 15, 16, 17, 18, 19, 20, 11, 12, 13)
canonical: [7, 5, 13, 25, 14, 6, 12, 21, 26, 15]
c1ccncc1
match: (22, 23, 24, 25, 26, 27)
canonical: [20, 10, 8, 18, 9, 11]
```

Canonical index of fragment when using fragment
```
$ python3 useFragment.py 
2019.09.1dev1
[0, 29, 1, 17, 32, 24, 4, 31, 2, 23, 3, 27, 22, 20, 10, 8, 18, 9, 11, 30, 16, 21, 12, 6, 14, 25, 13, 5, 7, 15, 26, 19, 28]
CC(C)Cn1c(=O)n(C)c(=O)c2c(-c3ccncc3)n(Cc3cccc4ccccc34)nc21
Cn1c(=O)[nH]c2n[nH]cc2c1=O
match: (4, 5, 6, 7, 8, 9, 10, 11, 12, 19, 31, 32)
canonical: [32, 24, 4, 31, 2, 23, 3, 27, 22, 30, 19, 28]
c1ccncc1
match: (13, 14, 15, 16, 17, 18)
canonical: [20, 10, 8, 18, 9, 11]
c1ccc2ccccc2c1
match: (21, 22, 23, 24, 25, 26, 27, 28, 29, 30)
canonical: [21, 12, 6, 14, 25, 13, 5, 7, 15, 26]
```

## 2019/05/15
Update fragment generation following Greg's advice.
Most fragments from both softwares seem to be the same up to canonical SMILES generation.

```
Fragments generated by RDKit
Cn1c(=O)[nH]c2n[nH]cc2c1=O NEMZYHPQUCOQPJ-UHFFFAOYSA-N
c1ccc2ccccc2c1 UFWIBTONFRDIAS-UHFFFAOYSA-N
c1ccncc1 JUJWROOIHBZHMG-UHFFFAOYSA-N

Fragments generated by Open Babel
Cn1c(=O)[nH]c2c(c1=O)c[nH]n2 NEMZYHPQUCOQPJ-UHFFFAOYSA-N
c1ccc2c(c1)cccc2 UFWIBTONFRDIAS-UHFFFAOYSA-N
c1cccnc1 JUJWROOIHBZHMG-UHFFFAOYSA-N
```
## 2019/05/10
Test fragment generation for Open Babel and RDKit.

Two libraries should do the same thing, but the treatment of hydrogens was different.

```
$ python fragment.py 003_2JFZ_A.sdf 
Fragments generated by RDKit
CN1C(=O)N=C2N=NC=C2C1=O QIODAUXUHNPIFH-UHFFFAOYSA-N
c1ccc2ccccc2c1 UFWIBTONFRDIAS-UHFFFAOYSA-N
c1ccncc1 JUJWROOIHBZHMG-UHFFFAOYSA-N

Fragments generated by Open Babel
Cn1c(=O)[nH]c2c(c1=O)c[nH]n2 NEMZYHPQUCOQPJ-UHFFFAOYSA-N
c1ccc2c(c1)cccc2 UFWIBTONFRDIAS-UHFFFAOYSA-N
c1cccnc1 JUJWROOIHBZHMG-UHFFFAOYSA-N
```
